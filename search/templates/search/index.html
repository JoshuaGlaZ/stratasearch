{% extends 'search/base.html' %} 

{% block content %}
<div class="h-full flex flex-col relative">
    
    <header class="w-full border-b border-white/5 bg-obsidian/80 backdrop-blur-md sticky top-0 z-20">
        <div class="max-w-5xl mx-auto px-6 h-16 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="w-8 h-8 flex items-center justify-center bg-emerald-500/10 rounded-lg border border-emerald-500/20">
                    <i class="fa-solid fa-layer-group text-emerald-500 text-sm"></i>
                </div>
                <h1 class="text-lg font-bold tracking-tight text-gray-200">
                    StrataSearch
                </h1>
            </div>
            <div class="hidden sm:flex items-center gap-2">
                <span class="w-2 h-2 rounded-full bg-emerald-500 animate-pulse"></span>
                <span class="text-xs text-gray-500 font-mono">SYSTEM ONLINE</span>
            </div>
        </div>
    </header>

    <div id="chat-log" class="flex-1 w-full overflow-y-auto scroll-smooth pt-8 pb-32">
        
        <div class="max-w-5xl mx-auto">
            
            <div id="welcome-screen" class="h-full flex flex-col items-center justify-center text-center fade-in py-12">
                <div class="mb-8 text-center">
                    <div class="inline-flex items-center justify-center w-20 h-20 rounded-2xl bg-charcoal border border-white/5 mb-6 shadow-2xl">
                        <i class="fa-solid fa-magnifying-glass text-3xl text-emerald-500"></i>
                    </div>
                    <h2 class="text-3xl font-bold text-white mb-3">Documentation Archaeologist</h2>
                    <p class="text-gray-400 max-w-md mx-auto">
                        I've indexed your library's documentation. Ask about migration paths or deprecated functions
                    </p>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 w-full">
                    <button onclick="fillAndSend('What is the migration path for declarative_base?')" 
                            class="text-left p-6 bg-charcoal border border-white/5 rounded-xl hover:border-emerald-500/50 hover:bg-white/5 transition-all group shadow-lg">
                        <div class="flex items-center gap-2 mb-2 text-emerald-500">
                            <i class="fa-solid fa-arrow-right-arrow-left"></i>
                            <span class="font-mono text-xs uppercase font-bold">Migration</span>
                        </div>
                        <h3 class="font-semibold text-gray-200 mb-1 group-hover:text-emerald-400">Declarative Base</h3>
                        <p class="text-xs text-gray-500">v1.4 to v2.0 style guide</p>
                    </button>

                    <button onclick="fillAndSend('Show me the modern pattern for Async Sessions.')" 
                            class="text-left p-6 bg-charcoal border border-white/5 rounded-xl hover:border-emerald-500/50 hover:bg-white/5 transition-all group shadow-lg">
                        <div class="flex items-center gap-2 mb-2 text-emerald-500">
                            <i class="fa-solid fa-database"></i>
                            <span class="font-mono text-xs uppercase font-bold">Patterns</span>
                        </div>
                        <h3 class="font-semibold text-gray-200 mb-1 group-hover:text-emerald-400">Async Sessions</h3>
                        <p class="text-xs text-gray-500">Best practices for async DB</p>
                    </button>

                    <button onclick="fillAndSend('Fix: AttributeError: module has no attribute execute')" 
                            class="text-left p-6 bg-charcoal border border-white/5 rounded-xl hover:border-emerald-500/50 hover:bg-white/5 transition-all group shadow-lg">
                        <div class="flex items-center gap-2 mb-2 text-emerald-500">
                            <i class="fa-solid fa-bug"></i>
                            <span class="font-mono text-xs uppercase font-bold">Troubleshoot</span>
                        </div>
                        <h3 class="font-semibold text-gray-200 mb-1 group-hover:text-emerald-400">Common Errors</h3>
                        <p class="text-xs text-gray-500">Fixing legacy attributes</p>
                    </button>
                </div>
            </div>

            </div> </div>

    <div class="absolute bottom-0 left-0 w-full z-30">
        <div class="absolute bottom-0 left-0 w-full h-48 bg-gradient-to-t from-obsidian via-obsidian to-transparent pointer-events-none"></div>

        <div class="relative px-6 pb-8 pt-4">
            <div class="max-w-5xl mx-auto">
                <form id="chat-form" hx-post="{% url 'chat' %}" class="w-full relative">
                    {% csrf_token %}
                    <div class="relative flex items-center bg-charcoal border border-white/10 rounded-xl shadow-2xl transition-colors focus-within:border-emerald-500/50 focus-within:ring-1 focus-within:ring-emerald-500/20">
                        <input type="text" id="user-input" name="message" 
                               class="flex-1 bg-transparent border-none outline-none text-gray-200 px-6 py-4 placeholder-gray-500 text-base font-medium"
                               placeholder="Ask a question about library difficulties or version conflicts..." 
                               autocomplete="off" autofocus>
                        
                        <button type="submit" class="mr-2 p-2 w-10 h-10 rounded-lg flex items-center justify-center text-emerald-500 hover:bg-emerald-500/10 transition-all">
                            <i class="fa-solid fa-arrow-up"></i>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
    const chatLog = document.getElementById("chat-log");
    const chatForm = document.getElementById("chat-form");
    const userInput = document.getElementById("user-input");

    const observer = new MutationObserver(() => {
        chatLog.scrollTo({ top: chatLog.scrollHeight, behavior: "smooth" });
    });
    observer.observe(document.querySelector('#chat-log > div'), { childList: true });

    document.body.addEventListener("htmx:beforeRequest", function (evt) {
        if (evt.detail.elt.id === "chat-form") {
            const message = userInput.value.trim();
            if (!message) return;

            const welcome = document.getElementById("welcome-screen");
            if (welcome) {
                welcome.style.opacity = "0";
                setTimeout(() => welcome.remove(), 300);
            }

            const container = document.querySelector('#chat-log > div');

            // 1. User Bubble
            const userBubbleHtml = `
            <div class="w-full animate-fade-in-up mb-8">
                <div class="flex items-start gap-4 justify-end">
                    <div class="flex-grow max-w-[85%]">
                        <div class="bg-steel/50 rounded-2xl rounded-tr-sm p-5 border border-white/5 text-gray-200 text-sm leading-relaxed whitespace-pre-wrap shadow-lg">${escapeHtml(message)}</div>
                    </div>
                    <div class="flex-shrink-0 mt-1">
                        <div class="w-8 h-8 bg-charcoal rounded-lg flex items-center justify-center border border-white/10">
                            <i class="fa-solid fa-user text-gray-500 text-xs"></i>
                        </div>
                    </div>
                </div>
            </div>`;
            
            container.insertAdjacentHTML("beforeend", userBubbleHtml);
            userInput.value = "";

            // 2. Ghost Bubble
            const uniqueId = "ai-response-" + Date.now();
            const ghostBubbleHtml = `
            <div id="${uniqueId}" class="w-full animate-fade-in-up mb-8">
                <div class="flex gap-4">
                    <div class="flex-shrink-0 mt-1">
                        <div class="w-8 h-8 bg-charcoal rounded-lg flex items-center justify-center border border-white/10 shadow-lg">
                            <i class="fa-solid fa-circle-notch fa-spin text-emerald-500 text-xs"></i>
                        </div>
                    </div>
                    <div class="flex-1 bg-charcoal/50 border border-white/5 rounded-2xl rounded-tl-sm p-6 shadow-xl">
                        <div class="space-y-3">
                            <div class="h-2 w-24 bg-steel rounded animate-pulse"></div>
                            <div class="h-2 w-full bg-steel/50 rounded animate-pulse"></div>
                            <div class="h-2 w-3/4 bg-steel/50 rounded animate-pulse"></div>
                        </div>
                    </div>
                </div>
            </div>`;
            
            container.insertAdjacentHTML("beforeend", ghostBubbleHtml);

            // HTMX Target Logic
            const targetElement = document.getElementById(uniqueId);
            if (targetElement) {
                evt.detail.target = targetElement;
                evt.detail.swap = "outerHTML";
            }
        }
    });

    function escapeHtml(text) {
        const div = document.createElement("div");
        div.textContent = text;
        return div.innerHTML;
    }

    function fillAndSend(text) {
        userInput.value = text;
        htmx.trigger(chatForm, "submit");
    }
</script>
{% endblock %}